# شرح منظومة التكاليف (End-to-End)

هذا الملف يشرح كيف تتحسب التكاليف في النظام بالكامل: من أين تأتي البيانات، وما المعادلات المستخدمة، وكيف تظهر في الشاشات.

## 1) مصادر بيانات التكلفة

- **تقارير الإنتاج اليومية**: `ProductionReport`
  - الكمية المنتجة `quantityProduced`
  - عدد عمال التشغيل `workersCount` (**بدون المشرف**)
  - ساعات العمل `workHours`
  - الخط `lineId`
  - المنتج `productId`
- **إعداد أجر الساعة**: `LaborSettings.hourlyRate`
- **مراكز التكلفة**: `CostCenter`
  - مباشر `direct`
  - غير مباشر `indirect`
- **قيمة مركز التكلفة الشهرية**: `CostCenterValue.amount`
- **أيام الشغل للمركز**: `CostCenterValue.workingDays` (أو أيام الشهر تلقائيًا)
- **نِسب توزيع المراكز غير المباشرة على الخطوط**: `CostAllocation.allocations`
- **تكلفة غير مباشرة للمشرف**:
  - من التقرير `supervisorIndirectCost` إن كانت محفوظة
  - أو من أجر المشرف بالساعة × ساعاته

## 2) الملفات الأساسية

- منطق الحسابات العام: `utils/costCalculations.ts`
- الحساب الشهري وتخزين النتائج: `modules/costs/services/monthlyProductionCostService.ts`
- شاشة مراجعة التكاليف الشهرية: `modules/costs/pages/MonthlyProductionCosts.tsx`
- إدخال قيم وتوزيع مراكز التكلفة: `modules/costs/pages/CostCenterDistribution.tsx`

## 3) معادلات الحساب الأساسية

## 3.1 التكلفة المباشرة

لكل تقرير:

`direct = workersCount × workHours × hourlyRate`

> ملاحظة مهمة: `workersCount` يمثل عمال التشغيل فقط، والمشرف لا يدخل ضمن هذا العدد.

إجمالي المباشر للمنتج في الشهر = مجموع المباشر لكل تقارير المنتج.

## 3.2 التكلفة غير المباشرة (المشتركة من مراكز التكلفة)

أولًا نحسب تكلفة الخط غير المباشرة اليومية من مراكز التكلفة غير المباشرة:

1. لكل مركز غير مباشر:
   - القيمة الشهرية للمركز × نسبة تخصيص الخط
2. الناتج يتحول ليومي:
   - `dailyAllocated = monthlyAllocated / workingDays`
3. مجموع كل المراكز = تكلفة الخط غير المباشرة اليومية.

ثم يتم توزيع تكلفة الخط اليومية على المنتجات داخل نفس اليوم/الخط:

- **الطريقة الحالية (الأدق)**: التوزيع حسب **ساعات التشغيل**.
- **Fallback**: لو الساعات غير متاحة، يتم التوزيع حسب الكمية.

بالتالي في نفس اليوم والخط:

- `productShare = reportWorkHours / totalLineWorkHours`  
  أو عند عدم توفر الساعات:  
  `productShare = reportQty / totalLineQty`

- `productIndirectShared = lineIndirectDaily × productShare`

## 3.3 تكلفة المشرف غير المباشرة

تضاف لكل تقرير:

- `supervisorIndirectCost` المحفوظة في التقرير (إن وجدت)
- أو `supervisorHourlyRate × workHours`

## 3.4 الإجمالي وتكلفة الوحدة

- `totalCost = totalDirect + totalIndirect`
- `averageUnitCost = totalCost / totalProducedQty`

## 4) لماذا كانت تظهر فروقات قبل التعديل؟

كان يحدث فرق أحيانًا لأن:

- عمود **إجمالي التكلفة** يأتي من سجل شهري محفوظ.
- عمود **مباشر/غير مباشر** كان يعاد حسابه لحظيًا من أحدث البيانات.

إذا تغيّرت أي مدخلات بعد آخر "حساب الكل" (قيمة مركز، توزيع، أجر ساعة، تقارير)، يظهر اختلاف.

تمت المعالجة في الواجهة بإضافة:

- تطبيع العرض بحيث مباشر + غير مباشر يطابق إجمالي التكلفة المعروض.
- تنبيه "البيانات تغيّرت بعد آخر حساب" مع زر إعادة حساب.

## 5) السلوك الصحيح المتوقع

إذا زادت الكمية مع ثبات ساعات العمل والعمال والمدخلات:

- إجمالي التكلفة لا يزيد بسبب الكمية نفسها.
- تكلفة القطعة (`averageUnitCost`) تنخفض غالبًا لأن التكلفة تتوزع على وحدات أكثر.

## 6) متى يلزم إعادة "حساب الكل"؟

بعد أي تعديل في:

- تقارير الإنتاج
- قيم مراكز التكلفة الشهرية
- نسب التوزيع على الخطوط
- أجر الساعة أو بيانات المشرف

حتى تتحدث سجلات `monthly_production_costs` وتطابق الواقع 1:1.

## 7) ملاحظة عملية للمراجعة السريعة

في شاشة `MonthlyProductionCosts` راقب دائمًا:

- `إجمالي التكلفة`
- `مباشر / غير مباشر`
- `متوسط تكلفة الوحدة`

ومع أي تنبيه أصفر (تغير مدخلات بعد آخر حساب)، اضغط **إعادة حساب الكل**.


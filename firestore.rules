rules_version = '2';

// ──────────────────────────────────────────────────────────────────────────────
// Firestore Security Rules — Dynamic Role-Based Access Control
//
// Roles are stored in /roles/{roleId} with a permissions map.
// Each user has a document at /users/{uid} with a roleId field + isActive flag.
//
// Bootstrap: first-time setup allows creating roles & user doc without existing data.
// ──────────────────────────────────────────────────────────────────────────────

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper Functions ───────────────────────────────────────────────────

    function isAuthenticated() {
      return request.auth != null;
    }

    function userDocExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isActiveUser() {
      return isAuthenticated() && userDocExists() && getUserDoc().isActive == true;
    }

    function getUserRoleId() {
      return getUserDoc().roleId;
    }

    function getRoleDoc() {
      return get(/databases/$(database)/documents/roles/$(getUserRoleId())).data;
    }

    function hasPermission(perm) {
      return isActiveUser() && getRoleDoc().permissions[perm] == true;
    }

    function isAdmin() {
      return hasPermission('roles.manage');
    }

    // Bootstrap: authenticated user without a user doc yet (first setup)
    function isBootstrap() {
      return isAuthenticated() && !userDocExists();
    }

    // ── Roles Collection ───────────────────────────────────────────────────
    // All authenticated users can read roles (not sensitive config data).
    // Only admin can write. Bootstrap allows creating initial roles.

    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isBootstrap();
      allow update, delete: if isAdmin();
    }

    // ── Users Collection ───────────────────────────────────────────────────
    // Users can read/create their own doc. Admin can manage all users.
    // Bootstrap: new user can create their own doc on first setup.

    match /users/{userId} {
      allow read: if isAuthenticated()
        && (request.auth.uid == userId || isAdmin());

      allow create: if isAuthenticated()
        && (request.auth.uid == userId || isAdmin());

      allow update: if isAuthenticated()
        && (request.auth.uid == userId || isAdmin());

      allow delete: if isAdmin();
    }

    // ── Products Collection ───────────────────────────────────────────────
    match /products/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('products.create');
      allow update: if hasPermission('products.edit');
      allow delete: if isAdmin();
    }

    // ── Production Lines Collection ───────────────────────────────────────
    match /production_lines/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('lines.create');
      allow update: if hasPermission('lines.edit');
      allow delete: if isAdmin();
    }

    // ── Employees Collection ─────────────────────────────────────────────
    match /employees/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('employees.create');
      allow update: if hasPermission('employees.edit');
      allow delete: if isAdmin();
    }

    // ── Approval Requests Collection ──────────────────────────────────────
    match /approval_requests/{docId} {
      allow read: if isActiveUser();
      allow create: if isActiveUser();
      allow update: if hasPermission('approval.manage') || isAdmin();
      allow delete: if isAdmin();
    }

    // ── Production Reports Collection ─────────────────────────────────────
    match /production_reports/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('reports.create');
      allow update: if hasPermission('reports.edit');
      allow delete: if isAdmin();
    }

    // ── Line Status Collection ────────────────────────────────────────────
    match /line_status/{docId} {
      allow read: if isActiveUser();
      allow create, update: if hasPermission('lineStatus.edit');
      allow delete: if isAdmin();
    }

    // ── Line Product Config Collection ────────────────────────────────────
    match /line_product_config/{docId} {
      allow read: if isActiveUser();
      allow create, update, delete: if isAdmin();
    }

    // ── Production Plans Collection ─────────────────────────────────────
    match /production_plans/{docId} {
      allow read: if hasPermission('plans.view');
      allow create: if hasPermission('plans.create');
      allow update: if hasPermission('plans.edit');
      allow delete: if isAdmin();
    }

    // ── Work Orders Collection ───────────────────────────────────────────
    match /work_orders/{docId} {
      allow read: if hasPermission('workOrders.view');
      allow create: if hasPermission('workOrders.create');
      allow update: if hasPermission('workOrders.edit');
      allow delete: if hasPermission('workOrders.delete') || isAdmin();
    }

    // ── Activity Logs Collection ──────────────────────────────────────────
    // Any authenticated user can create logs. Only admin can read/delete.
    match /activity_logs/{docId} {
      allow read: if hasPermission('activityLog.view');
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ── Audit Logs Collection ─────────────────────────────────────────────
    // Event-based immutable audit timeline for cross-module actions.
    match /audit_logs/{docId} {
      allow read: if hasPermission('activityLog.view');
      allow create: if isActiveUser();
      allow update, delete: if false;
    }

    // ── System Settings Collection ─────────────────────────────────────
    // All active users can read. Only admin can write.
    match /system_settings/{docId} {
      allow read: if isActiveUser();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── Backups Collection (history log) ──────────────────────────────────
    // Only admin can read, create, and delete backup history entries.
    match /backups/{docId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // ── Cost Centers Collection ──────────────────────────────────────────
    match /cost_centers/{docId} {
      allow read: if isActiveUser();
      allow create, update, delete: if isAdmin();
    }

    // ── Cost Center Values Collection ────────────────────────────────────
    match /cost_center_values/{docId} {
      allow read: if isActiveUser();
      allow create, update, delete: if isAdmin();
    }

    // ── Cost Allocations Collection ──────────────────────────────────────
    match /cost_allocations/{docId} {
      allow read: if isActiveUser();
      allow create, update, delete: if isAdmin();
    }

    // ── Labor Settings Collection ────────────────────────────────────────
    match /labor_settings/{docId} {
      allow read: if isActiveUser();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Departments ──────────────────────────────────────────────────
    match /departments/{docId} {
      allow read: if isActiveUser();
      allow create, update: if hasPermission('attendance.edit') || isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Job Positions ─────────────────────────────────────────────────
    match /job_positions/{docId} {
      allow read: if isActiveUser();
      allow create, update: if hasPermission('attendance.edit') || isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Shifts ────────────────────────────────────────────────────────
    match /shifts/{docId} {
      allow read: if isActiveUser();
      allow create, update: if hasPermission('attendance.edit') || isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Settings (single doc) ─────────────────────────────────────────
    match /hr_settings/{docId} {
      allow read: if isActiveUser();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Penalty Rules ─────────────────────────────────────────────────
    match /penalty_rules/{docId} {
      allow read: if isActiveUser();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Late Rules ────────────────────────────────────────────────────
    match /late_rules/{docId} {
      allow read: if isActiveUser();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Allowance Types ───────────────────────────────────────────────
    match /allowance_types/{docId} {
      allow read: if isActiveUser();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Attendance Raw Logs ───────────────────────────────────────────
    match /attendance_raw_logs/{docId} {
      allow read: if hasPermission('attendance.view');
      allow create: if hasPermission('attendance.import');
      allow update: if hasPermission('attendance.edit');
      allow delete: if isAdmin();
    }

    // ── HR: Attendance Logs (processed) ───────────────────────────────────
    match /attendance_logs/{docId} {
      allow read: if hasPermission('attendance.view');
      allow create: if hasPermission('attendance.import');
      allow update: if hasPermission('attendance.edit');
      allow delete: if isAdmin();
    }

    // ── HR: Leave Requests ────────────────────────────────────────────────
    match /leave_requests/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('leave.create') || hasPermission('leave.manage');
      allow update: if hasPermission('leave.manage') || isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Leave Balances ────────────────────────────────────────────────
    match /leave_balances/{docId} {
      allow read: if isActiveUser();
      allow create, update: if hasPermission('leave.manage') || isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Employee Loans ────────────────────────────────────────────────
    match /employee_loans/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('loan.create') || hasPermission('loan.manage');
      allow update: if hasPermission('loan.manage') || isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Approval Settings ─────────────────────────────────────────────
    match /approval_settings/{docId} {
      allow read: if isActiveUser();
      allow create, update: if hasPermission('approval.manage') || isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Approval Delegations ──────────────────────────────────────────
    match /approval_delegations/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('approval.delegate') || hasPermission('approval.manage');
      allow update: if hasPermission('approval.manage') || isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR: Approval Audit Logs ───────────────────────────────────────────
    match /approval_audit_logs/{docId} {
      allow read: if hasPermission('approval.view');
      allow create: if isActiveUser();
      allow update, delete: if false;
    }

    // ── Payroll: Payroll Months ───────────────────────────────────────────
    match /payroll_months/{docId} {
      allow read: if hasPermission('payroll.view');
      allow create: if hasPermission('payroll.generate');
      allow update: if hasPermission('payroll.finalize') || hasPermission('payroll.lock');
      allow delete: if isAdmin();
    }

    // ── Payroll: Payroll Records ──────────────────────────────────────────
    match /payroll_records/{docId} {
      allow read: if hasPermission('payroll.view');
      allow create: if hasPermission('payroll.generate');
      allow update: if hasPermission('payroll.finalize') || hasPermission('payroll.lock');
      allow delete: if hasPermission('payroll.generate');
    }

    // ── Payroll: Payroll Audit Logs ───────────────────────────────────────
    match /payroll_audit_logs/{docId} {
      allow read: if hasPermission('payroll.view');
      allow create: if isActiveUser();
      allow update, delete: if false;
    }

    // ── Payroll: Cost Summary ─────────────────────────────────────────────
    match /payroll_cost_summary/{docId} {
      allow read: if hasPermission('payroll.view');
      allow create, update: if hasPermission('payroll.finalize');
      allow delete: if isAdmin();
    }

    // ── HR Config: Modules ────────────────────────────────────────────────
    match /hr_config_modules/{docId} {
      allow read: if isActiveUser();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── HR Config: Audit Logs ─────────────────────────────────────────────
    match /hr_config_audit_logs/{docId} {
      allow read: if isActiveUser();
      allow create: if isActiveUser();
      allow update, delete: if false;
    }

    // ── Quality: Settings ──────────────────────────────────────────────────
    match /quality_settings/{docId} {
      allow read: if hasPermission('quality.settings.view');
      allow create, update: if hasPermission('quality.settings.manage');
      allow delete: if isAdmin();
    }

    // ── Quality: Reason Catalog ────────────────────────────────────────────
    match /quality_reason_catalog/{docId} {
      allow read: if hasPermission('quality.settings.view') || hasPermission('quality.finalInspection.view') || hasPermission('quality.ipqc.view');
      allow create, update, delete: if hasPermission('quality.settings.manage');
    }

    // ── Quality: Worker Assignments ────────────────────────────────────────
    match /quality_workers_assignments/{docId} {
      allow read: if hasPermission('quality.workers.view');
      allow create, update, delete: if hasPermission('quality.workers.manage');
    }

    // ── Quality: Inspections ───────────────────────────────────────────────
    match /quality_inspections/{docId} {
      allow read: if hasPermission('quality.finalInspection.view') || hasPermission('quality.ipqc.view') || hasPermission('quality.reports.view');
      allow create: if hasPermission('quality.finalInspection.inspect') || hasPermission('quality.ipqc.inspect');
      allow update: if hasPermission('quality.finalInspection.inspect') || hasPermission('quality.ipqc.inspect') || hasPermission('quality.approve');
      allow delete: if isAdmin();
    }

    // ── Quality: Defects ───────────────────────────────────────────────────
    match /quality_defects/{docId} {
      allow read: if hasPermission('quality.finalInspection.view') || hasPermission('quality.ipqc.view') || hasPermission('quality.reports.view');
      allow create, update: if hasPermission('quality.finalInspection.inspect') || hasPermission('quality.ipqc.inspect') || hasPermission('quality.rework.manage');
      allow delete: if isAdmin();
    }

    // ── Quality: Rework Orders ─────────────────────────────────────────────
    match /quality_rework_orders/{docId} {
      allow read: if hasPermission('quality.rework.view') || hasPermission('quality.reports.view');
      allow create, update: if hasPermission('quality.rework.manage');
      allow delete: if isAdmin();
    }

    // ── Quality: CAPA ──────────────────────────────────────────────────────
    match /quality_capa/{docId} {
      allow read: if hasPermission('quality.capa.view') || hasPermission('quality.reports.view');
      allow create, update: if hasPermission('quality.capa.manage');
      allow delete: if isAdmin();
    }

    // ── Quality: Print Logs ────────────────────────────────────────────────
    match /quality_print_logs/{docId} {
      allow read: if hasPermission('quality.reports.view');
      allow create: if hasPermission('quality.print');
      allow update, delete: if false;
    }

    // ── Catch-all: deny everything else ───────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

rules_version = '2';

// ──────────────────────────────────────────────────────────────────────────────
// Firestore Security Rules — Dynamic Role-Based Access Control
//
// Roles are stored in /roles/{roleId} with a permissions map.
// Each user has a document at /users/{uid} with a roleId field + isActive flag.
//
// Bootstrap: first-time setup allows creating roles & user doc without existing data.
// ──────────────────────────────────────────────────────────────────────────────

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper Functions ───────────────────────────────────────────────────

    function isAuthenticated() {
      return request.auth != null;
    }

    function userDocExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isActiveUser() {
      return isAuthenticated() && userDocExists() && getUserDoc().isActive == true;
    }

    function getUserRoleId() {
      return getUserDoc().roleId;
    }

    function getRoleDoc() {
      return get(/databases/$(database)/documents/roles/$(getUserRoleId())).data;
    }

    function hasPermission(perm) {
      return isActiveUser() && getRoleDoc().permissions[perm] == true;
    }

    function isAdmin() {
      return hasPermission('roles.manage');
    }

    // Bootstrap: authenticated user without a user doc yet (first setup)
    function isBootstrap() {
      return isAuthenticated() && !userDocExists();
    }

    // ── Roles Collection ───────────────────────────────────────────────────
    // All authenticated users can read roles (not sensitive config data).
    // Only admin can write. Bootstrap allows creating initial roles.

    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isBootstrap();
      allow update, delete: if isAdmin();
    }

    // ── Users Collection ───────────────────────────────────────────────────
    // Users can read/create their own doc. Admin can manage all users.
    // Bootstrap: new user can create their own doc on first setup.

    match /users/{userId} {
      allow read: if isAuthenticated()
        && (request.auth.uid == userId || isAdmin());

      allow create: if isAuthenticated()
        && (request.auth.uid == userId || isAdmin());

      allow update: if isAuthenticated()
        && (request.auth.uid == userId || isAdmin());

      allow delete: if isAdmin();
    }

    // ── Products Collection ───────────────────────────────────────────────
    match /products/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('products.create');
      allow update: if hasPermission('products.edit');
      allow delete: if isAdmin();
    }

    // ── Production Lines Collection ───────────────────────────────────────
    match /production_lines/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('lines.create');
      allow update: if hasPermission('lines.edit');
      allow delete: if isAdmin();
    }

    // ── Supervisors Collection ────────────────────────────────────────────
    match /supervisors/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('supervisors.create');
      allow update: if hasPermission('supervisors.edit');
      allow delete: if isAdmin();
    }

    // ── Production Reports Collection ─────────────────────────────────────
    match /production_reports/{docId} {
      allow read: if isActiveUser();
      allow create: if hasPermission('reports.create');
      allow update: if hasPermission('reports.edit');
      allow delete: if isAdmin();
    }

    // ── Line Status Collection ────────────────────────────────────────────
    match /line_status/{docId} {
      allow read: if isActiveUser();
      allow create, update: if hasPermission('lineStatus.edit');
      allow delete: if isAdmin();
    }

    // ── Line Product Config Collection ────────────────────────────────────
    match /line_product_config/{docId} {
      allow read: if isActiveUser();
      allow create, update, delete: if isAdmin();
    }

    // ── Activity Logs Collection ──────────────────────────────────────────
    // Any authenticated user can create logs. Only admin can read/delete.
    match /activity_logs/{docId} {
      allow read: if hasPermission('activityLog.view');
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ── Catch-all: deny everything else ───────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
